exec = require('child_process').exec
makeRequest = require('make_request')
resp = ['/attempts/judge_results','/admin/problems/judge_results','/problems/judge_results']
run_cmd=""

process.on('uncaughtException', (err) ->
  console.error(""))


runner = (id, run_command, run_extension, return_type, timeout, cases, channel)->
  dir = "/tmp/progs/"+id+'/'
  for key, value of cases
    do(key, value)->

      value.input = value.input.concat("\n") if value.input.slice(-1) != "\n"

      run_cmd="sudo -u ale "+run_command.replace(/%s/,dir).replace(/%s/,run_extension)
            
      run_exe = exec(run_cmd, (error, stdout, stderr) ->
        if stderr.trim() == 'Terminated'
          makeRequest({'id':id,'error_code':2, 'stderr':'timeout'}, resp[return_type])
        else if stderr != ""
          makeRequest({'id':id,'error_code':1,'stderr':stderr}, resp[return_type])
        else
          if return_type == 0
            result = if (stdout==value.output) then true else false
          else
            result = stdout
          makeRequest({'id':id,'error_code':null,'case':key,'result':result, 'channel':channel}, resp[return_type])
      )

      run_exe.stdin.write value.input

      setTimeout(->
        console.log("sudo killall /tmp/progs/#{id}/*")
        exec("sudo killall /tmp/progs/#{id}/*")
        exec("sudo rm -rf /tmp/progs/#{id}")
      ,timeout*1000)

module.exports = runner
