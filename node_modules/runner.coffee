exec = require('child_process').exec
makeRequest = require('make_request')
dir = "/tmp/progs/"

runner = (id,return_type,cases)->
  for key, value of cases
    do(key, value)->
      run_exe = exec dir+id,  (error, stdout, stderr) ->
        if error
          makeRequest({'stderr':stderr, 'error':error},3000)
        else
          if return_type == 0
            result = if (stdout==value.output) then true else false
            makeRequest({'id':id,'case':key,'result':result, 'url':'attempts/judge_results'},3000)
          else if return_type == 1
            makeRequest({'id':id,'case':key,'result':stdout, 'url':'attempts/judge_results'},3000)
          else if return_type == 2
            makeRequest({'id':id,'case':key,'result':stdout, 'url':'toolkit/judge_results'},3000)
      process.stdin.setMaxListeners(0)
      process.stdin.pipe(run_exe.stdin)
      run_exe.stdin.write(value.input)


module.exports = runner
