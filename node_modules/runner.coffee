exec = require('child_process').exec
makeRequest = require('make_request')
dir = "/tmp/progs/"

runner = (id,return_type,timeout,cases)->
  for key, value of cases
    do(key, value)->
      value = value.concat("\n") if value.slice(-2) != "\n"
      run_exe = exec dir+id,  (error, stdout, stderr) ->
        if error
          stderr = "timedout after #{timeout} seconds" if error['signal'] == 'SIGKILL'
          if return_type == 0
            makeRequest({'id':id,'stderr':stderr, 'error':error},'/attempts/judge_results')
          else if return_type == 1
            makeRequest({'id':id,'stderr':stderr, 'error':error},'/admin/problems/judge_results')
        else
          if return_type == 0
            result = if (stdout==value.output) then true else false
            makeRequest({'id':id,'case':key,'result':result},'/attempts/judge_results')
          else if return_type == 1
            makeRequest({'id':id,'case':key,'result':stdout},'/admin/problems/judge_results')
          else if return_type == 2
            makeRequest({'id':id,'case':key,'result':stdout},'/problems/judge_results')
      exec "ruby timeout.rb #{run_exe.pid} #{timeout}"
      process.stdin.setMaxListeners(0)
      process.stdin.pipe(run_exe.stdin)
      run_exe.stdin.write(value.input)

module.exports = runner
