exec = require('child_process').exec
makeRequest = require('make_request')
fs = require 'fs'
dir = "./progs/"

compiler = (json, callback)->
  do (json) ->
    file_name = json.attempt_id + '.' + json.attempt_ext
    file_content = JSON.parse(json.source)
    command = json.command.replace(/%s/g,dir+json.attempt_id)
    fs.writeFile(dir+file_name, file_content, (error) ->
      compile_exe = exec command, (error, stdout, stderr) ->
        if error
          makeRequest({'attempt_id':json.attempt_id, 'eror':error,'message':"#{json.attempt_id} didn't compile"},3000)
        else
          callback(json.attempt_id, json.compare, json.cases))

module.exports = compiler
