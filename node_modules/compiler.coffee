exec = require('child_process').exec
makeRequest = require('make_request')
fs = require 'fs'
resp = ['/attempts/judge_results','/admin/problems/judge_results']

compiler = (json, callback)->
  dir = "/tmp/progs/"+json.id+'/'
  fs.mkdirSync(dir)
  do (json) ->
    file_name =  'Main.' + json.ext
    file_content = JSON.parse(json.source)
    command = json.command.replace(/%s/g,dir+'Main')
    fs.writeFile(dir+file_name, file_content, (error) ->
      compile_exe = exec command, (error, stdout, stderr) ->
        if error
          makeRequest({'id':json.id, 'error_code':0, 'stderr':stderr.replace(/‘/g, "\'").replace(/’/g, "\'")}, resp[json.return_type])
        else
          callback(json.id, json.run_command, json.run_extension, json.return_type, json.time, json.cases, json.channel))

module.exports = compiler
