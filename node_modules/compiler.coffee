exec = require('child_process').exec
makeRequest = require('make_request')
fs = require 'fs'
dir = "/tmp/progs/"

compiler = (json, callback)->
  do (json) ->
    file_name = json.id + '.' + json.ext
    file_content = JSON.parse(json.source)
    command = json.command.replace(/%s/g,dir+json.id)
    fs.writeFile(dir+file_name, file_content, (error) ->
      compile_exe = exec command, (error, stdout, stderr) ->
        if error
          stderr = stderr.replace(/‘/g, "\'").replace(/’/g, "\'")
          if json.return_type == 0
            makeRequest({'id':json.id,'stderr':stderr, 'error':error},'/attempts/judge_results')
          else if json.return_type == 1
            makeRequest({'stderr':stderr, 'error':error},'/admin/problems/judge_results')
        else
          callback(json.id, json.return_type, json.time, json.cases))

module.exports = compiler
